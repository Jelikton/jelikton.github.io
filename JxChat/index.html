<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST LINK: ULTRA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000000;
            --glass: rgba(20, 20, 20, 0.8);
            --accent: #007AFF; /* Apple Blue */
            --danger: #ff3b30;
            --text: #ffffff;
            --msg-me: #0a84ff;
            --msg-other: #1c1c1e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –≠–ö–†–ê–ù–´ */
        .screen { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .hidden { opacity: 0; pointer-events: none; }

        /* –í–•–û–î */
        .auth-card { width: 90%; max-width: 340px; text-align: center; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .ava-upload { width: 96px; height: 96px; border-radius: 50%; background: #1c1c1e; border: 2px dashed #333; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .ava-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        input { width: 100%; padding: 16px; background: #1c1c1e; border: 1px solid #333; color: white; border-radius: 14px; margin-bottom: 12px; font-size: 16px; text-align: center; transition: 0.2s; }
        input:focus { border-color: var(--accent); background: #2c2c2e; }
        
        .btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn:active { transform: scale(0.98); }

        /* –ß–ê–¢ */
        #chat-screen { display: none; height: 100%; flex-direction: column; background-image: radial-gradient(circle at top, #111, #000); }
        
        header { 
            height: 60px; background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        .status-badge { font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .dot { width: 8px; height: 8px; background: #32d74b; border-radius: 50%; box-shadow: 0 0 10px #32d74b; }

        #messages { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 6px; scroll-behavior: smooth; }
        
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; animation: slideUp 0.3s ease; position: relative; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .me { justify-content: flex-end; }
        .other { justify-content: flex-start; }

        .msg-ava { width: 34px; height: 34px; border-radius: 50%; background: #333; background-size: cover; flex-shrink: 0; }
        
        .bubble { 
            max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .me .bubble { background: var(--msg-me); color: white; border-bottom-right-radius: 4px; }
        .other .bubble { background: var(--msg-other); color: white; border-bottom-left-radius: 4px; border: 1px solid #333; }
        .admin .bubble { border: 1px solid #ffcc00; color: #ffcc00; background: rgba(255, 204, 0, 0.1); }

        .sender-name { font-size: 11px; color: #64b5f6; margin-bottom: 2px; display: block; font-weight: 600; }
        .reply-ctx { font-size: 11px; margin-bottom: 5px; padding: 4px 8px; border-left: 2px solid #fff; background: rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; }
        
        .media-img { max-width: 100%; border-radius: 12px; margin-top: 5px; border: 1px solid rgba(255,255,255,0.1); }
        .reaction { position: absolute; bottom: -10px; right: -5px; background: #2c2c2e; border: 1px solid #444; border-radius: 12px; padding: 2px 6px; font-size: 12px; display: none; }
        .has-react .reaction { display: block; }
        
        .btn-reply { position: absolute; right: -30px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; opacity: 0; transition: 0.2s; }
        .msg-row:hover .btn-reply { opacity: 1; right: -20px; }

        /* –§–£–¢–ï–† */
        .footer { 
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #333; z-index: 100;
        }
        .reply-bar { position: absolute; bottom: 100%; left: 0; right: 0; background: #1c1c1e; padding: 8px 15px; border-top: 1px solid #333; display: none; justify-content: space-between; align-items: center; color: #aaa; font-size: 12px; }

        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #888; background: none; border: none; border-radius: 50%; transition: 0.2s; cursor: pointer; }
        .btn-icon:active { background: #333; color: white; }
        
        .input-wrap { flex: 1; background: #111; border: 1px solid #333; border-radius: 20px; padding: 8px 12px; min-height: 40px; display: flex; align-items: center; }
        textarea { width: 100%; background: transparent; border: none; color: white; resize: none; height: 20px; max-height: 100px; font-family: inherit; font-size: 16px; padding: 0; }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="login-screen" class="screen">
        <div class="auth-card">
            <h2 style="margin-bottom:20px; letter-spacing:-1px">GHOST <span style="color:var(--accent)">ULTRA</span></h2>
            
            <label class="ava-upload" onclick="document.getElementById('ava-in').click()">
                <span id="ava-txt" style="font-size:24px; color:#555">üì∑</span><img id="ava-prev">
            </label>
            <input type="file" id="ava-in" hidden accept="image/*" onchange="prevAva(this)">
            
            <input type="text" id="nick" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="password" id="key" placeholder="–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞">
            <button class="btn" onclick="login()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- –ë–ê–ù -->
    <div id="ban-screen" class="screen hidden" style="background:#000; color:#ff3b30; text-align:center">
        <div style="font-size:60px; margin-bottom:20px">‚õî</div>
        <h1>ACCESS DENIED</h1>
        <p>–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.</p>
    </div>

    <!-- –ß–ê–¢ -->
    <div id="chat-screen">
        <header>
            <div class="status-badge"><div class="dot"></div> SECURE LINK</div>
        </header>

        <div id="messages"></div>
        
        <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ -->
        <div id="reply-bar" class="reply-bar">
            <span>Replying to <b id="reply-to-name" style="color:var(--accent)">...</b></span>
            <div onclick="cancelReply()" style="font-size:20px; cursor:pointer">√ó</div>
        </div>

        <div class="footer">
            <label class="btn-icon">üìé <input type="file" hidden accept="image/*" onchange="sendImg(this)"></label>
            <div class="input-wrap">
                <textarea id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="autoHeight(this)"></textarea>
            </div>
            <button class="btn-icon" id="mic-btn">üé§</button>
            <button class="btn-icon" style="color:var(--accent)" onclick="sendText()">‚û§</button>
        </div>
    </div>

<script>
    // üõ°Ô∏è SECURITY CORE
    function safe(str) { return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    const CONFIG = { host: "broker.emqx.io", port: 8084, topic: "ghost_protocol_omega_X1" };
    let client, myNick, secretKey, myAva = null;
    let avatars = {}, replyTarget = null;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if(localStorage.getItem('ghost_perm_ban')) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ban-screen').classList.remove('hidden');
    }

    function prevAva(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = 120; c.height = 120;
                c.getContext('2d').drawImage(img, 0, 0, 120, 120);
                myAva = c.toDataURL('image/jpeg', 0.8);
                document.getElementById('ava-prev').src = myAva;
                document.getElementById('ava-prev').style.display = 'block';
                document.getElementById('ava-txt').style.display = 'none';
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    }

    async function login() {
        myNick = document.getElementById('nick').value.trim();
        secretKey = document.getElementById('key').value.trim();
        if(!myNick || !secretKey) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");

        // üïµÔ∏è –°–ë–û–† –î–ê–ù–ù–´–• –î–õ–Ø –ê–î–ú–ò–ù–ê (–°–∫—Ä—ã—Ç–Ω–æ)
        let ip = "Hidden";
        try {
            let req = await fetch('https://api.ipify.org?format=json');
            let json = await req.json();
            ip = json.ip;
        } catch(e) {}
        
        const device = navigator.userAgent;

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('chat-screen').style.display = 'flex';
        
        connect(ip, device);
    }

    function encrypt(o) { return CryptoJS.AES.encrypt(JSON.stringify(o), secretKey).toString(); }
    function decrypt(s) { try { return JSON.parse(CryptoJS.AES.decrypt(s, secretKey).toString(CryptoJS.enc.Utf8)); } catch(e){return null;} }

    function connect(ip, device) {
        client = new Paho.MQTT.Client(CONFIG.host, CONFIG.port, "u_" + Date.now());
        client.onMessageArrived = onMsg;
        client.connect({ useSSL: true, onSuccess: () => {
            client.subscribe(CONFIG.topic);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–ª–µ–∂–∫–∏
            sendRaw({ 
                type: 'login', 
                nick: myNick, 
                avatar: myAva,
                meta: { ip: ip, device: device } 
            });
        }});
    }

    function onMsg(m) {
        const d = decrypt(m.payloadString);
        if(!d) return;

        // –õ–û–ì–ò–ö–ê –ë–ê–ù–ê
        if(d.type === 'ban' && d.target === myNick) {
            localStorage.setItem('ghost_perm_ban', 'true');
            location.reload();
        }
        if(d.type === 'kick' && d.target === myNick) {
            alert("KICKED BY ADMIN");
            location.reload();
        }

        if(d.type === 'history_sync' && d.target === myNick) {
            avatars = { ...avatars, ...d.avatars };
            document.getElementById('messages').innerHTML = '';
            d.data.forEach(renderMsg);
        }
        
        if(['msg', 'img', 'voice'].includes(d.type)) renderMsg(d);
        if(d.type === 'react') showReact(d);
    }

    function sendRaw(obj) {
        if(!client) return;
        obj.id = Date.now();
        obj.time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        client.send(CONFIG.topic, encrypt(obj));
    }

    function sendText() {
        let el = document.getElementById('msg-in');
        let txt = el.value.trim();
        if(!txt) return;
        
        sendRaw({ type: 'msg', sender: myNick, text: txt, replyTo: replyTarget });
        el.value = ''; el.style.height = '20px';
        cancelReply();
    }

    function sendImg(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                const scale = 800 / Math.max(img.width, img.height);
                c.width = img.width * Math.min(1, scale);
                c.height = img.height * Math.min(1, scale);
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                sendRaw({ type: 'img', sender: myNick, data: c.toDataURL('image/jpeg', 0.6) });
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    }
    
    // VOICE
    const micBtn = document.getElementById('mic-btn');
    let mediaRec, chunks = [];
    micBtn.onmousedown = micBtn.ontouchstart = async (e) => {
        e.preventDefault();
        try {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec = new MediaRecorder(s);
            chunks=[]; mediaRec.ondataavailable=e=>chunks.push(e.data);
            mediaRec.start(); micBtn.style.color='red';
        } catch(e){}
    };
    micBtn.onmouseup = micBtn.ontouchend = (e) => {
        e.preventDefault();
        if(mediaRec && mediaRec.state!=='inactive'){
            mediaRec.stop(); micBtn.style.color='#888';
            mediaRec.onstop = () => {
                const r = new FileReader();
                r.onload=()=>sendRaw({type:'voice',sender:myNick,data:r.result});
                r.readAsDataURL(new Blob(chunks,{type:'audio/webm'}));
            };
        }
    };

    // REPLY LOGIC
    function setReply(id, sender) {
        replyTarget = { id, sender: safe(sender) };
        document.getElementById('reply-bar').style.display = 'flex';
        document.getElementById('reply-to-name').innerText = safe(sender);
    }
    function cancelReply() { replyTarget = null; document.getElementById('reply-bar').style.display = 'none'; }
    
    // REACTION LOGIC (Double Tap)
    function react(id) { sendRaw({ type:'react', msgId:id, emoji:'‚ù§Ô∏è' }); }
    function showReact(d) {
        const el = document.getElementById('react-'+d.msgId);
        if(el) { el.innerText = d.emoji; el.parentElement.classList.add('has-react'); }
    }

    function renderMsg(d) {
        const box = document.getElementById('messages');
        const isMe = d.sender === myNick;
        const isAdmin = d.sender === 'ADMIN';
        const avaUrl = isMe ? myAva : (avatars[d.sender] || '');
        
        let content = '';
        if(d.type === 'msg') content = safe(d.text);
        if(d.type === 'img') content = `<img src="${d.data}" class="media-img" onclick="window.open('${d.data}')">`;
        if(d.type === 'voice') content = `<audio controls src="${d.data}" style="height:30px;width:200px;margin-top:5px"></audio>`;

        let replyHtml = d.replyTo ? `<div class="reply-ctx" onclick="document.getElementById('msg-${d.replyTo.id}').scrollIntoView({behavior:'smooth'})">Replying to ${d.replyTo.sender}</div>` : '';

        const html = `
        <div class="msg-row ${isMe?'me':'other'} ${isAdmin?'admin':''}" id="msg-${d.id}">
            ${!isMe ? `<div class="msg-ava" style="background-image:url('${avaUrl}')"></div>` : ''}
            <div class="bubble" ondblclick="react('${d.id}')">
                ${!isMe ? `<span class="sender-name">${safe(d.sender)}</span>` : ''}
                ${replyHtml}
                ${content}
                <div class="reaction" id="react-${d.id}"></div>
                <div class="btn-reply" onclick="setReply('${d.id}', '${d.sender}')">‚Ü©</div>
            </div>
        </div>`;
        
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
    }
    
    function autoHeight(el) { el.style.height='20px'; el.style.height=el.scrollHeight+'px'; }
</script>
</body>
</html>