<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST LINK: ULTRA</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #000000;
            --accent: #007AFF;
            --msg-me: #0a84ff;
            --msg-other: #1c1c1e;
            --text: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* –≠–ö–†–ê–ù–´ */
        .screen { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .hidden { opacity: 0; pointer-events: none; }

        /* –í–•–û–î */
        .auth-card { width: 90%; max-width: 320px; text-align: center; }
        .ava-upload { width: 100px; height: 100px; border-radius: 50%; background: #1c1c1e; border: 2px dashed #333; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .ava-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        input { width: 100%; padding: 15px; background: #1c1c1e; border: 1px solid #333; color: white; border-radius: 12px; margin-bottom: 10px; font-size: 16px; text-align: center; }
        .btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; }

        /* –ß–ê–¢ */
        #chat-screen { display: none; height: 100%; flex-direction: column; background: radial-gradient(circle at top, #111, #000); }
        
        header { 
            height: 50px; background: rgba(10,10,10,0.9); border-bottom: 1px solid #222; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; 
            z-index: 100; backdrop-filter: blur(10px);
        }

        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; position: relative; }
        .me { justify-content: flex-end; }
        
        .msg-ava { width: 32px; height: 32px; border-radius: 50%; background: #333; background-size: cover; flex-shrink: 0; border: 1px solid #333; }
        
        .bubble { 
            max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; position: relative;
        }
        .me .bubble { background: var(--msg-me); border-bottom-right-radius: 4px; color: white; }
        .other .bubble { background: var(--msg-other); border: 1px solid #333; border-bottom-left-radius: 4px; }
        .admin .bubble { border: 1px solid #facc15; color: #facc15; background: rgba(250, 204, 21, 0.1); }

        .sender-name { font-size: 11px; color: #64b5f6; margin-bottom: 4px; display: block; font-weight: 600; }
        .reply-ctx { font-size: 11px; margin-bottom: 5px; padding: 4px 8px; border-left: 2px solid #fff; background: rgba(255,255,255,0.1); border-radius: 4px; cursor: pointer; }
        
        .media-img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        
        /* –†–ï–ê–ö–¶–ò–ò –ò –û–¢–í–ï–¢–´ */
        .reaction { position: absolute; bottom: -8px; right: -5px; background: #222; border: 1px solid #444; border-radius: 10px; padding: 2px 6px; font-size: 11px; display: none; z-index: 10; }
        .has-react .reaction { display: block; }
        
        .btn-reply { position: absolute; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; font-size: 18px; padding: 5px; opacity: 0; transition: 0.2s; }
        .me .btn-reply { left: -30px; } 
        .other .btn-reply { right: -30px; }
        .msg-row:hover .btn-reply { opacity: 1; }

        /* –§–£–¢–ï–† */
        .footer { background: #111; padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #222; position: relative; z-index: 200; }
        
        .reply-bar { position: absolute; bottom: 100%; left: 0; right: 0; background: #1c1c1e; padding: 8px 15px; border-top: 1px solid #333; display: none; justify-content: space-between; align-items: center; font-size: 12px; color: #aaa; }
        
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #888; background: none; border: none; cursor: pointer; border-radius: 50%; }
        .btn-icon:active { background: #222; color: #fff; }
        
        .input-wrap { flex: 1; background: #222; border-radius: 20px; padding: 8px 12px; min-height: 40px; display: flex; align-items: center; }
        textarea { width: 100%; background: transparent; border: none; color: white; resize: none; height: 20px; max-height: 100px; font-family: inherit; font-size: 16px; padding: 0; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –í–•–û–î–ê -->
    <div id="login-screen" class="screen">
        <div class="auth-card">
            <h2 style="margin-bottom:20px;">GHOST <span style="color:var(--accent)">ULTRA</span></h2>
            
            <label class="ava-upload" onclick="document.getElementById('ava-in').click()">
                <span id="ava-txt" style="font-size:30px; color:#555">üì∑</span><img id="ava-prev">
            </label>
            <input type="file" id="ava-in" hidden accept="image/*" onchange="prevAva(this)">
            
            <input type="text" id="nick" placeholder="–¢–≤–æ–µ –∏–º—è">
            <!-- –ü–ê–†–û–õ–¨ –í–ü–ò–°–ê–ù -->
            <input type="password" id="key" placeholder="–ü–∞—Ä–æ–ª—å" value="elisey1!">
            <button class="btn" onclick="login()">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <!-- –ë–ê–ù -->
    <div id="ban-screen" class="screen hidden" style="background:#000; color:#ff3b30; text-align:center">
        <div style="font-size:50px">‚õî</div>
        <h1>ACCESS DENIED</h1>
        <p>–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –Ω–∞–≤—Å–µ–≥–¥–∞.</p>
    </div>

    <!-- –ß–ê–¢ -->
    <div id="chat-screen">
        <header>SECURE CHANNEL</header>
        
        <div id="messages"></div>
        
        <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ -->
        <div id="reply-bar" class="reply-bar">
            <span>–û—Ç–≤–µ—Ç –¥–ª—è <b id="reply-to-name" style="color:var(--accent)">...</b></span>
            <div onclick="cancelReply()" style="font-size:20px; cursor:pointer">√ó</div>
        </div>

        <div class="footer">
            <!-- –°–ö–†–ï–ü–ö–ê -->
            <label class="btn-icon">üìé <input type="file" hidden accept="image/*" onchange="sendImg(this)"></label>
            
            <div class="input-wrap">
                <textarea id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="autoHeight(this)"></textarea>
            </div>
            
            <!-- –ú–ò–ö–†–û–§–û–ù -->
            <button class="btn-icon" id="mic-btn">üé§</button>
            
            <!-- –û–¢–ü–†–ê–í–ò–¢–¨ -->
            <button class="btn-icon" style="color:var(--accent)" onclick="sendText()">‚û§</button>
        </div>
    </div>

<script>
    // üõ°Ô∏è XSS –ó–ê–©–ò–¢–ê
    function safe(str) { return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }

    const CONFIG = { host: "broker.emqx.io", port: 8084, topic: "ghost_protocol_omega_X1" };
    let client, myNick, secretKey, myAva = null;
    let avatars = {}; 
    let replyTarget = null;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if(localStorage.getItem('ghost_perm_ban')) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ban-screen').classList.remove('hidden');
    }

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏
    function prevAva(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = 150; c.height = 150;
                c.getContext('2d').drawImage(img, 0, 0, 150, 150);
                myAva = c.toDataURL('image/jpeg', 0.8);
                document.getElementById('ava-prev').src = myAva;
                document.getElementById('ava-prev').style.display = 'block';
                document.getElementById('ava-txt').style.display = 'none';
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    }

    async function login() {
        myNick = document.getElementById('nick').value.trim();
        secretKey = document.getElementById('key').value.trim();
        if(!myNick || !secretKey) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

        // –°–õ–ï–ñ–ö–ê –î–õ–Ø –ê–î–ú–ò–ù–ê
        let ip = "–°–∫—Ä—ã—Ç";
        try { let req = await fetch('https://api.ipify.org?format=json'); let json = await req.json(); ip = json.ip; } catch(e) {}
        const device = navigator.userAgent;

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('chat-screen').style.display = 'flex';
        
        connect(ip, device);
    }

    function encrypt(o) { return CryptoJS.AES.encrypt(JSON.stringify(o), secretKey).toString(); }
    function decrypt(s) { try { return JSON.parse(CryptoJS.AES.decrypt(s, secretKey).toString(CryptoJS.enc.Utf8)); } catch(e){return null;} }

    function connect(ip, device) {
        client = new Paho.MQTT.Client(CONFIG.host, CONFIG.port, "u_" + Date.now());
        client.onMessageArrived = onMsg;
        client.connect({ useSSL: true, onSuccess: () => {
            client.subscribe(CONFIG.topic);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω—É
            sendRaw({ 
                type: 'login', 
                nick: myNick, 
                avatar: myAva,
                meta: { ip: ip, device: device } 
            });
        }});
    }

    function onMsg(m) {
        const d = decrypt(m.payloadString);
        if(!d) return;

        if(d.type === 'ban' && d.target === myNick) { localStorage.setItem('ghost_perm_ban', 'true'); location.reload(); }
        if(d.type === 'kick' && d.target === myNick) { alert("KICKED"); location.reload(); }

        // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ò–°–¢–û–†–ò–ò –ò –ê–í–ê–¢–ê–†–û–ö
        if(d.type === 'history_sync' && d.target === myNick) {
            if(d.avatars) avatars = { ...avatars, ...d.avatars };
            document.getElementById('messages').innerHTML = '';
            d.data.forEach(renderMsg);
        }
        
        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ê–í–ê–¢–ê–†–û–ö –ü–†–ò –í–•–û–î–ï –î–†–£–ì–ò–•
        if(d.type === 'login' && d.avatar) {
            avatars[d.nick] = d.avatar;
        }

        if(['msg', 'img', 'voice'].includes(d.type)) renderMsg(d);
        if(d.type === 'react') showReact(d);
    }

    function sendRaw(obj) {
        if(!client) return;
        obj.id = Date.now();
        obj.time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        client.send(CONFIG.topic, encrypt(obj));
    }

    // –¢–ï–ö–°–¢
    function sendText() {
        let el = document.getElementById('msg-in');
        let txt = el.value.trim();
        if(!txt) return;
        
        sendRaw({ type: 'msg', sender: myNick, text: txt, replyTo: replyTarget });
        el.value = ''; el.style.height = '20px';
        cancelReply();
    }

    // –§–û–¢–û (–°–∂–∞—Ç–∏–µ)
    function sendImg(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                const scale = 800 / Math.max(img.width, img.height);
                c.width = img.width * Math.min(1, scale);
                c.height = img.height * Math.min(1, scale);
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                sendRaw({ type: 'img', sender: myNick, data: c.toDataURL('image/jpeg', 0.6) });
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    }
    
    // –ì–û–õ–û–°
    const micBtn = document.getElementById('mic-btn');
    let mediaRec, chunks = [];
    micBtn.onmousedown = micBtn.ontouchstart = async (e) => {
        e.preventDefault();
        try {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRec = new MediaRecorder(s);
            chunks=[]; mediaRec.ondataavailable=e=>chunks.push(e.data);
            mediaRec.start(); micBtn.style.color='red';
        } catch(e){}
    };
    micBtn.onmouseup = micBtn.ontouchend = (e) => {
        e.preventDefault();
        if(mediaRec && mediaRec.state!=='inactive'){
            mediaRec.stop(); micBtn.style.color='#888';
            mediaRec.onstop = () => {
                const r = new FileReader();
                r.onload=()=>sendRaw({type:'voice',sender:myNick,data:r.result});
                r.readAsDataURL(new Blob(chunks,{type:'audio/webm'}));
            };
        }
    };

    // –û–¢–í–ï–¢–´
    function setReply(id, sender) {
        replyTarget = { id, sender: safe(sender) };
        document.getElementById('reply-bar').style.display = 'flex';
        document.getElementById('reply-to-name').innerText = safe(sender);
    }
    function cancelReply() { replyTarget = null; document.getElementById('reply-bar').style.display = 'none'; }
    
    // –†–ï–ê–ö–¶–ò–ò (–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)
    function react(id) { sendRaw({ type:'react', msgId:id, emoji:'‚ù§Ô∏è' }); }
    function showReact(d) {
        const el = document.getElementById('react-'+d.msgId);
        if(el) { el.innerText = d.emoji; el.parentElement.classList.add('has-react'); }
    }

    // –û–¢–†–ò–°–û–í–ö–ê
    function renderMsg(d) {
        const box = document.getElementById('messages');
        const isMe = d.sender === myNick;
        const isAdmin = d.sender === 'ADMIN';
        
        // –ò—â–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É: –°–≤–æ—é, –ê–¥–º–∏–Ω–∞ –∏–ª–∏ –î—Ä—É–≥–∏—Ö
        let avaUrl = '';
        if (isMe) avaUrl = myAva;
        else if (isAdmin) avaUrl = 'https://cdn-icons-png.flaticon.com/512/2942/2942813.png'; // –ò–∫–æ–Ω–∫–∞ –∞–¥–º–∏–Ω–∞
        else avaUrl = avatars[d.sender] || ''; // –ê–≤–∞—Ç–∞—Ä–∫–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞

        let content = '';
        if(d.type === 'msg') content = safe(d.text);
        if(d.type === 'img') content = `<img src="${d.data}" class="media-img" onclick="window.open('${d.data}')">`;
        if(d.type === 'voice') content = `<audio controls src="${d.data}" style="height:30px;width:200px;margin-top:5px"></audio>`;

        // HTML –û—Ç–≤–µ—Ç–∞
        let replyHtml = d.replyTo ? `<div class="reply-ctx" onclick="document.getElementById('msg-${d.replyTo.id}').scrollIntoView({behavior:'smooth'})">–û—Ç–≤–µ—Ç –¥–ª—è ${d.replyTo.sender}</div>` : '';

        const html = `
        <div class="msg-row ${isMe?'me':'other'} ${isAdmin?'admin':''}" id="msg-${d.id}">
            ${!isMe ? `<div class="msg-ava" style="background-image:url('${avaUrl}')"></div>` : ''}
            <div class="bubble" ondblclick="react('${d.id}')">
                ${!isMe ? `<span class="sender-name">${safe(d.sender)}</span>` : ''}
                ${replyHtml}
                ${content}
                <div class="reaction" id="react-${d.id}"></div>
                <div class="btn-reply" onclick="setReply('${d.id}', '${d.sender}')">‚Ü©</div>
            </div>
        </div>`;
        
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
    }
    
    function autoHeight(el) { el.style.height='20px'; el.style.height=el.scrollHeight+'px'; }
</script>
</body>
</html>
