<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST LINK: ULTRA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg:#000; --glass:rgba(20,20,20,0.95); --accent:#007AFF; --text:#fff; --me:#007AFF; --other:#1c1c1e; --priv:#7c3aed; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
        body { margin:0; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

        /* –í–•–û–î */
        .screen { position:fixed; inset:0; z-index:150; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.3s; }
        .hidden { opacity:0; pointer-events:none; }
        
        .auth-card { width:90%; max-width:340px; text-align:center; animation:pop 0.5s ease; }
        @keyframes pop { from{transform:scale(0.9);opacity:0} to{transform:scale(1);opacity:1} }
        
        .ava-upload { width:100px; height:100px; border-radius:50%; background:#111; border:2px dashed #333; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; position:relative; }
        .ava-upload.err { border-color:#ef4444; animation:shake 0.3s; }
        .ava-upload img { width:100%; height:100%; object-fit:cover; display:none; }
        
        input { width:100%; padding:14px; background:#1c1c1e; border:1px solid #333; color:#fff; border-radius:12px; margin-bottom:10px; font-size:15px; text-align:center; }
        .btn { width:100%; padding:14px; background:var(--accent); color:#fff; border:none; border-radius:12px; font-weight:800; cursor:pointer; font-size:16px; transition:0.3s; }
        .btn:disabled { opacity:0.5; cursor:wait; }

        /* –ß–ê–¢ */
        #chat-screen { display:none; height:100%; flex-direction:column; background-color: #0f172a; background-image: url("https://web.telegram.org/img/bg_0.png"); background-size: cover; background-position: center; }
        
        header { height:55px; background:var(--glass); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; padding:0 15px; z-index:10; font-weight:bold; justify-content:space-between; }
        .head-left { display:flex; align-items:center; gap:15px; }
        
        /* BURGER MENU */
        .burger { font-size:24px; cursor:pointer; }

        /* SIDEBAR (USERS) */
        .sidebar { position:fixed; top:0; left:0; bottom:0; width:280px; background:#111; z-index:200; transform:translateX(-100%); transition:0.3s; border-right:1px solid #333; display:flex; flex-direction:column; }
        .sidebar.open { transform:translateX(0); }
        .sb-head { padding:20px; border-bottom:1px solid #333; font-weight:bold; display:flex; justify-content:space-between; }
        .sb-list { flex:1; overflow-y:auto; padding:10px; }
        .sb-user { display:flex; align-items:center; gap:10px; padding:10px; border-radius:8px; cursor:pointer; transition:0.2s; }
        .sb-user:active { background:#222; }
        .sb-ava { width:32px; height:32px; border-radius:50%; background:#333; background-size:cover; position:relative; }
        .sb-stat { width:8px; height:8px; background:#555; border-radius:50%; position:absolute; bottom:0; right:0; border:2px solid #111; }
        .sb-stat.on { background:#10b981; }

        .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:190; display:none; }
        .overlay.active { display:block; }
        
        #messages { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:6px; }
        
        .msg-row { display:flex; align-items:flex-end; gap:8px; position:relative; animation:slide 0.2s; }
        @keyframes slide { from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }
        
        .me { justify-content:flex-end; }
        .msg-ava { width:32px; height:32px; border-radius:50%; background:#333; background-size:cover; flex-shrink:0; cursor:pointer; }
        
        .bubble { max-width:75%; padding:8px 12px; border-radius:16px; font-size:15px; line-height:1.4; position:relative; word-wrap:break-word; box-shadow:0 1px 2px rgba(0,0,0,0.3); }
        .me .bubble { background:var(--me); border-bottom-right-radius:4px; color:#fff; }
        .other .bubble { background:var(--other); border-bottom-left-radius:4px; }
        .priv .bubble { background:var(--priv); border:1px solid #a78bfa; }
        .admin .bubble { border:1px solid #fbbf24; background:rgba(251,191,36,0.15); color:#fbbf24; }

        .sender-name { font-size:11px; color:#60a5fa; margin-bottom:2px; display:block; font-weight:bold; }
        .priv-tag { background:rgba(0,0,0,0.3); padding:2px 4px; border-radius:4px; font-size:9px; color:#ddd; margin-left:5px; }

        .media-img { max-width:100%; border-radius:10px; margin-top:5px; border:1px solid rgba(255,255,255,0.1); }
        
        /* REACTION */
        .reaction-badge { position:absolute; bottom:-10px; right:-5px; background:#222; border:1px solid #444; padding:2px 6px; border-radius:10px; font-size:12px; display:none; box-shadow:0 2px 4px rgba(0,0,0,0.5); z-index:5; }
        .has-react .reaction-badge { display:block; animation:pop 0.3s; }

        .msg-reply-ctx { font-size:11px; margin-bottom:4px; padding:4px 8px; border-left:2px solid rgba(255,255,255,0.5); background:rgba(0,0,0,0.2); border-radius:4px; cursor:pointer; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

        /* FOOTER */
        .footer { background:var(--glass); padding:8px; display:flex; align-items:flex-end; gap:8px; border-top:1px solid rgba(255,255,255,0.1); position:relative; z-index:20; }
        
        .bar-panel { position:absolute; bottom:100%; left:0; right:0; padding:8px 15px; font-size:12px; display:none; justify-content:space-between; align-items:center; backdrop-filter:blur(10px); }
        .dm-bar { background:#2e1065; border-top:1px solid #a78bfa; }
        .reply-bar { background:#1c1c1e; border-top:1px solid #333; }
        
        .btn-icon { width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-size:20px; color:#888; background:none; border:none; border-radius:50%; transition:0.2s; cursor:pointer; }
        .btn-icon:active { background:#333; color:#fff; }
        
        textarea { flex:1; background:#1c1c1e; border:none; color:#fff; border-radius:20px; padding:10px 14px; resize:none; height:40px; font-family:inherit; font-size:16px; max-height:100px; }
        
        /* MODAL */
        #modal { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200; display:none; align-items:center; justify-content:center; }
        .modal-box { background:#1c1c1e; width:80%; max-width:300px; border-radius:16px; overflow:hidden; text-align:center; }
        .modal-btn { padding:18px; border-bottom:1px solid #333; cursor:pointer; font-size:16px; font-weight:500; }
        .modal-btn:active { background:#333; }
        
        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)} }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen" class="screen">
        <div class="auth-card">
            <h2 style="color:var(--accent)">GHOST ID</h2>
            
            <label class="ava-upload" id="ava-box" onclick="document.getElementById('ava-in').click()">
                <span id="ava-txt" style="font-size:30px; color:#555">üì∑</span><img id="ava-prev">
            </label>
            <input type="file" id="ava-in" hidden accept="image/*" onchange="prevAva(this)">
            
            <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω (ID)" oninput="this.value=this.value.replace(/[^a-zA-Z0-9]/g,'')">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="displayname" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
            
            <button id="login-btn" class="btn" onclick="login()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
        </div>
    </div>

    <!-- BAN SCREEN -->
    <div id="ban-screen" class="screen hidden" style="background:#000; color:#ef4444; text-align:center">
        <div style="font-size:60px">‚õî</div>
        <h1>–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù</h1>
        <p>–í—ã –±—ã–ª–∏ –∑–∞–±–∞–Ω–µ–Ω—ã.</p>
        <button class="btn" style="margin-top:20px; width:auto; background:#333" onclick="location.reload()">–ü–†–û–í–ï–†–ò–¢–¨ –°–¢–ê–¢–£–°</button>
    </div>

    <!-- SIDEBAR & OVERLAY -->
    <div class="overlay" onclick="toggleMenu(false)"></div>
    <div class="sidebar" id="sidebar">
        <div class="sb-head">
            <span>–ö–û–ù–¢–ê–ö–¢–´</span>
            <span onclick="toggleMenu(false)" style="cursor:pointer">‚úï</span>
        </div>
        <div class="sb-list" id="user-list-ui"></div>
    </div>

    <!-- CHAT UI -->
    <div id="chat-screen">
        <header>
            <div class="head-left">
                <div class="burger" onclick="toggleMenu(true)">‚ò∞</div>
                <div id="top-title">GLOBAL CHAT</div>
            </div>
            <div id="conn-stat" style="width:8px;height:8px;border-radius:50%;background:#f59e0b"></div>
        </header>
        
        <div id="messages"></div>

        <!-- BARS -->
        <div id="reply-bar" class="bar-panel reply-bar">
            <span>–û—Ç–≤–µ—Ç –Ω–∞: <b id="rep-text" style="color:#aaa">...</b></span>
            <div onclick="cancelReply()" style="font-size:20px;cursor:pointer">√ó</div>
        </div>
        <div id="dm-bar" class="bar-panel dm-bar">
            <span>üîí –ß–ê–¢ –°: <b id="dm-name">...</b></span>
            <div onclick="exitDm()" style="font-size:20px;cursor:pointer">√ó</div>
        </div>

        <div class="footer">
            <label class="btn-icon">üìé <input type="file" hidden accept="image/*" onchange="sendImg(this)"></label>
            <textarea id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" oninput="autoResize(this)"></textarea>
            <button class="btn-icon" id="mic-btn">üé§</button>
            <button class="btn-icon" style="color:var(--accent)" onclick="sendText()">‚û§</button>
        </div>
    </div>

    <!-- OPTION MODAL -->
    <div id="modal" onclick="this.style.display='none'">
        <div class="modal-box">
            <div class="modal-btn" onclick="startDmFromModal()">–ù–∞–ø–∏—Å–∞—Ç—å –ª–∏—á–Ω–æ üîí</div>
            <div class="modal-btn" onclick="setReplyFromModal()">–û—Ç–≤–µ—Ç–∏—Ç—å ‚Ü©</div>
            <div class="modal-btn" style="color:#ef4444">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

<script>
    function safe(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
    
    const CONFIG = { host: "broker.emqx.io", port: 8084, topic: "ghost_protocol_omega_X1" };
    let client, myUser, myPass, myName, secretKey="elisey1!", myAva=null;
    let usersMap = {}; 
    let selectedUser=null, selectedMsgId=null, selectedMsgText=null;
    let replyTarget=null, currentDm=null;
    let pingInterval;

    // –ü–†–û–í–ï–†–ö–ê –ë–ê–ù–ê
    if(localStorage.getItem('gh_banned') === '1') {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ban-screen').classList.remove('hidden');
        setTimeout(() => connectMqtt('Unknown', true), 1000);
    }

    function prevAva(input) {
        let f=input.files[0]; if(!f)return;
        let r=new FileReader();
        r.onload=e=>{
            let i=new Image(); i.onload=()=>{
                let c=document.createElement('canvas'); c.width=150;c.height=150;
                c.getContext('2d').drawImage(i,0,0,150,150);
                myAva=c.toDataURL('image/jpeg',0.7);
                document.getElementById('ava-prev').src=myAva;
                document.getElementById('ava-prev').style.display='block';
                document.getElementById('ava-txt').style.display='none';
                document.getElementById('ava-box').style.borderColor='#333';
            }; i.src=e.target.result;
        }; r.readAsDataURL(f);
    }

    async function login() {
        if(!myAva) return alert("–ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞!");
        myUser = document.getElementById('username').value.trim();
        myPass = document.getElementById('password').value.trim();
        myName = document.getElementById('displayname').value.trim();
        
        if(!myUser || !myName || !myPass) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–õ–æ–≥–∏–Ω, –ü–∞—Ä–æ–ª—å, –ò–º—è)!");
        if(myUser.toLowerCase().includes('admin')) return alert("–ò–º—è ADMIN –∑–∞–ø—Ä–µ—â–µ–Ω–æ!");

        localStorage.setItem('gh_me', myUser);
        let btn = document.getElementById('login-btn');
        btn.disabled = true;
        btn.innerText = "–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï...";

        let ip="Unknown"; try{let r=await fetch('https://api.ipify.org?format=json');let j=await r.json();ip=j.ip;}catch(e){}

        connectMqtt(ip, false);
    }

    function connectMqtt(ip, isBannedMode) {
        let uName = isBannedMode ? localStorage.getItem('gh_me') : myUser;
        if(!uName) uName = "guest_" + Math.random();

        let clientId = "USR_" + uName + "_" + Math.floor(Math.random()*1000);
        client = new Paho.MQTT.Client(CONFIG.host, CONFIG.port, clientId);
        
        client.onConnectionLost = (resp) => {
            document.getElementById('conn-stat').style.background = '#ef4444';
            setTimeout(() => connectMqtt(ip, isBannedMode), 3000);
        };

        client.onMessageArrived = (m) => onMsg(m, uName);

        client.connect({
            useSSL:true, 
            keepAliveInterval: 30,
            onSuccess:()=>{
                document.getElementById('conn-stat').style.background = '#10b981';
                client.subscribe(CONFIG.topic);
                
                if(!isBannedMode) {
                    // !!! –í–ê–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–¢–ö–†–´–í–ê–ï–ú –ß–ê–¢ –°–†–ê–ó–£ –ü–û–°–õ–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø !!!
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('chat-screen').style.display='flex';

                    // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –õ–û–ì–ò–ù –° –ü–ê–†–û–õ–ï–ú
                    sendRaw({
                        type:'login', 
                        username: myUser,
                        password: myPass, 
                        name: myName, 
                        avatar: myAva, 
                        meta:{ip:ip, ua:navigator.userAgent}
                    });
                    
                    clearInterval(pingInterval);
                    pingInterval = setInterval(() => {
                        sendRaw({type:'ping', username: myUser});
                    }, 10000);
                }
            },
            onFailure: (e) => {
                alert("–û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø: " + e.errorMessage);
                let btn = document.getElementById('login-btn');
                btn.disabled = false;
                btn.innerText = "–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨";
            }
        });
    }

    function onMsg(m, currentNick) {
        let d=null; try{d=JSON.parse(CryptoJS.AES.decrypt(m.payloadString,secretKey).toString(CryptoJS.enc.Utf8));}catch(e){}
        if(!d)return;

        // 0. –û–®–ò–ë–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò (–ù–ï–í–ï–†–ù–´–ô –ü–ê–†–û–õ–¨)
        if(d.type === 'auth_fail' && d.target === currentNick) {
            alert("–û–®–ò–ë–ö–ê –í–•–û–î–ê: " + d.reason);
            location.reload(); 
            return;
        }

        // 1. –£–°–ü–ï–®–ù–´–ô –í–•–û–î (–ü–û–õ–£–ß–ï–ù–ò–ï –ò–°–¢–û–†–ò–ò)
        if(d.type === 'history_sync' && d.target === currentNick) {
            if(d.users) usersMap = d.users;
            renderSidebar();
            
            document.getElementById('messages').innerHTML = '';
            if(d.data && Array.isArray(d.data)) {
                d.data.forEach(msg => {
                    if(msg.type === 'dm' && msg.target !== myUser && msg.sender !== myUser) return;
                    renderMsg(msg);
                });
            }
        }

        // 2. –ë–ê–ù / –†–ê–ó–ë–ê–ù
        if(d.type==='ban' && d.target===currentNick) { 
            localStorage.setItem('gh_banned','1'); 
            location.reload(); 
        }
        if(d.type === 'unban' && d.target === currentNick) {
            localStorage.removeItem('gh_banned');
            alert("–í–ê–° –†–ê–ó–ë–ê–ù–ò–õ–ò! –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ê...");
            location.reload();
        }
        if(d.type==='kick' && d.target===currentNick) { 
            alert("KICKED"); location.reload(); 
        }

        // 3. –û–ë–´–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø
        if(d.type==='login') {
            usersMap[d.username] = { name: d.name, avatar: d.avatar, isOnline: true };
            renderSidebar();
        }
        if(['msg','img','voice','dm'].includes(d.type)) {
            if(d.type==='dm') { if(d.target!==myUser && d.sender!==myUser) return; }
            if(currentDm) {
                if( (d.sender===currentDm && d.target===myUser) || (d.sender===myUser && d.target===currentDm) ) renderMsg(d);
            } else {
                if(d.type !== 'dm') renderMsg(d);
            }
        }
        if(d.type==='react') {
            let el=document.getElementById('react-'+d.msgId);
            if(el){ el.innerText=d.emoji; el.parentElement.classList.add('has-react'); }
        }
    }

    function sendRaw(o) {
        o.id = Date.now() + Math.random().toString().substr(2,5);
        o.time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        if(!o.sender) o.sender = myUser;
        if(!o.name) o.name = myName;
        
        let enc = CryptoJS.AES.encrypt(JSON.stringify(o),secretKey).toString();
        client.send(CONFIG.topic, enc);
    }

    function sendText() {
        let txt = document.getElementById('msg-in').value.trim(); 
        if(!txt) return;
        let p = { text:txt, replyTo:replyTarget };
        if(currentDm) { p.type = 'dm'; p.target = currentDm; } else { p.type = 'msg'; }
        sendRaw(p);
        document.getElementById('msg-in').value='';
        document.getElementById('msg-in').style.height='40px';
        cancelReply();
    }

    function sendImg(inp) {
        let f=inp.files[0]; if(!f)return;
        let r=new FileReader();
        r.onload=e=>{
            let i=new Image(); i.onload=()=>{
                let c=document.createElement('canvas'); 
                let s=800/Math.max(i.width,i.height);
                c.width=i.width*Math.min(1,s); c.height=i.height*Math.min(1,s);
                c.getContext('2d').drawImage(i,0,0,c.width,c.height);
                let p = { data:c.toDataURL('image/jpeg',0.6) };
                if(currentDm) { p.type='dm'; p.isImg=true; p.target=currentDm; } else { p.type='img'; }
                sendRaw(p);
            }; i.src=e.target.result;
        }; r.readAsDataURL(f);
    }
    
    // VOICE
    let mic=document.getElementById('mic-btn'), mr, chunks=[];
    mic.onmousedown=mic.ontouchstart=async(e)=>{
        e.preventDefault();
        try{let s=await navigator.mediaDevices.getUserMedia({audio:true}); mr=new MediaRecorder(s);
        chunks=[]; mr.ondataavailable=e=>chunks.push(e.data); mr.start(); mic.style.color='red';}catch(e){}
    };
    mic.onmouseup=mic.ontouchend=(e)=>{
        e.preventDefault(); if(mr&&mr.state!=='inactive'){mr.stop(); mic.style.color='#888';
        mr.onstop=()=>{
            let r=new FileReader(); r.onload=()=>{
                let p = { data:r.result };
                if(currentDm) { p.type='dm'; p.isVoice=true; p.target=currentDm; } else { p.type='voice'; }
                sendRaw(p);
            }; r.readAsDataURL(new Blob(chunks,{type:'audio/webm'}));
        }}
    };

    function toggleMenu(open) {
        let sb = document.getElementById('sidebar');
        let ov = document.querySelector('.overlay');
        if(open) { sb.classList.add('open'); ov.classList.add('active'); }
        else { sb.classList.remove('open'); ov.classList.remove('active'); }
    }

    function renderSidebar() {
        const list = document.getElementById('user-list-ui');
        list.innerHTML = '';
        for(let u in usersMap) {
            if(u === myUser) continue;
            let usr = usersMap[u];
            let onlineCls = usr.isOnline ? 'on' : '';
            list.innerHTML += `
            <div class="sb-user" onclick="startDm('${u}')">
                <div class="sb-ava" style="background-image:url('${usr.avatar}')"><div class="sb-stat ${onlineCls}"></div></div>
                <div>${safe(usr.name)}</div>
            </div>`;
        }
    }

    function startDm(u) {
        currentDm = u;
        toggleMenu(false);
        document.getElementById('dm-bar').style.display='flex';
        document.getElementById('dm-name').innerText = usersMap[u]?.name || u;
        document.getElementById('top-title').innerText = "PRIVATE CHAT";
        document.getElementById('top-title').style.color = "#a78bfa";
        document.getElementById('messages').innerHTML = '<div style="text-align:center;color:#555;padding:20px">–ù–∞—á–∞–ª–æ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞</div>';
    }

    function exitDm() {
        currentDm = null;
        document.getElementById('dm-bar').style.display='none';
        document.getElementById('top-title').innerText = "GLOBAL CHAT";
        document.getElementById('top-title').style.color = "#fff";
        sendRaw({type:'login', username:myUser, password:myPass, name:myName, avatar:myAva});
    }

    function showOpts(user, msgId, text) {
        if(user===myUser || user==='ADMIN') return;
        selectedUser=user; selectedMsgId=msgId; selectedMsgText=text;
        document.getElementById('modal').style.display='flex';
    }
    
    function startDmFromModal() { document.getElementById('modal').style.display='none'; startDm(selectedUser); }
    function setReplyFromModal() { document.getElementById('modal').style.display='none'; replyTarget = { id: selectedMsgId, sender: selectedUser, text: selectedMsgText.substring(0,20)+"..." }; document.getElementById('reply-bar').style.display='flex'; document.getElementById('rep-text').innerText = replyTarget.text; }
    function cancelReply(){ replyTarget=null; document.getElementById('reply-bar').style.display='none'; }
    function react(id) { sendRaw({type:'react', msgId:id, emoji:'‚ù§Ô∏è'}); }

    function renderMsg(d) {
        let box = document.getElementById('messages');
        let isMe = d.sender === myUser;
        let isAdmin = d.sender === 'ADMIN';
        let isDm = d.type === 'dm';
        let avaUrl = isMe ? myAva : (usersMap[d.sender]?.avatar || '');
        if(isAdmin) avaUrl = 'https://cdn-icons-png.flaticon.com/512/2942/2942813.png';
        let displayName = isMe ? '–í—ã' : (usersMap[d.sender]?.name || d.sender);
        let content = safe(d.text || '');
        if(d.type==='img' || d.isImg) content=`<img src="${d.data}" class="media-img" onclick="window.open('${d.data}')">`;
        if(d.type==='voice' || d.isVoice) content=`<audio controls src="${d.data}" style="height:32px;width:200px;margin-top:5px"></audio>`;
        let replyHtml = d.replyTo ? `<div class="msg-reply-ctx" onclick="document.getElementById('msg-${d.replyTo.id}')?.scrollIntoView({behavior:'smooth'})">‚Ü© ${safe(d.replyTo.sender)}: ${safe(d.replyTo.text)}</div>` : '';
        let dmTag = isDm ? `<span class="priv-tag">üîí –õ–°</span>` : '';
        let safeText = (d.text || '').replace(/'/g, "\\'");

        let html = `
        <div class="msg-row ${isMe?'me':'other'} ${isDm?'priv':''} ${isAdmin?'admin':''}" id="msg-${d.id}">
            ${!isMe ? `<div class="msg-ava" style="background-image:url('${avaUrl}')" onclick="showOpts('${d.sender}','${d.id}','${safeText}')"></div>` : ''}
            <div class="bubble" ondblclick="react('${d.id}')">
                ${!isMe ? `<span class="sender-name">${safe(displayName)} ${dmTag}</span>` : ''}
                ${replyHtml}
                ${content}
                <div class="reaction-badge" id="react-${d.id}"></div>
            </div>
        </div>`;
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
    }
    function autoResize(el) { el.style.height = '40px'; el.style.height = el.scrollHeight + 'px'; }
</script>
</body>
</html>
