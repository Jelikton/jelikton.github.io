<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST LINK: ULTRA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg:#000; --glass:rgba(20,20,20,0.9); --accent:#007AFF; --text:#fff; --me:#007AFF; --other:#1c1c1e; --priv:#7c3aed; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
        body { margin:0; font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); height:100vh; overflow:hidden; display:flex; flex-direction:column; }

        /* –í–•–û–î */
        .screen { position:fixed; inset:0; z-index:50; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.3s; }
        .hidden { opacity:0; pointer-events:none; }
        
        .auth-card { width:90%; max-width:340px; text-align:center; animation:pop 0.5s ease; }
        @keyframes pop { from{transform:scale(0.9);opacity:0} to{transform:scale(1);opacity:1} }
        
        .ava-upload { width:120px; height:120px; border-radius:50%; background:#111; border:2px dashed #333; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; position:relative; }
        .ava-upload.err { border-color:#ef4444; animation:shake 0.3s; }
        .ava-upload img { width:100%; height:100%; object-fit:cover; display:none; }
        
        input { width:100%; padding:16px; background:#1c1c1e; border:1px solid #333; color:#fff; border-radius:14px; margin-bottom:12px; font-size:16px; text-align:center; }
        .btn { width:100%; padding:16px; background:var(--accent); color:#fff; border:none; border-radius:14px; font-weight:800; cursor:pointer; font-size:16px; }

        /* –ß–ê–¢ */
        #chat-screen { display:none; height:100%; flex-direction:column; background:radial-gradient(circle at top,#111,#000); }
        
        header { height:55px; background:rgba(10,10,10,0.85); backdrop-filter:blur(20px); border-bottom:1px solid rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; z-index:10; font-weight:bold; }
        
        #messages { flex:1; overflow-y:auto; padding:20px 15px; display:flex; flex-direction:column; gap:8px; }
        
        .msg-row { display:flex; align-items:flex-end; gap:8px; position:relative; animation:slide 0.2s; }
        @keyframes slide { from{transform:translateY(10px);opacity:0} to{transform:translateY(0);opacity:1} }
        
        .me { justify-content:flex-end; }
        .msg-ava { width:34px; height:34px; border-radius:50%; background:#333; background-size:cover; flex-shrink:0; cursor:pointer; }
        
        .bubble { max-width:75%; padding:10px 14px; border-radius:18px; font-size:15px; line-height:1.4; position:relative; word-wrap:break-word; }
        .me .bubble { background:var(--me); border-bottom-right-radius:4px; }
        .other .bubble { background:var(--other); border:1px solid #333; border-bottom-left-radius:4px; }
        .priv .bubble { background:var(--priv); border:1px solid #a78bfa; }
        .admin .bubble { border:1px solid #fbbf24; background:rgba(251,191,36,0.1); color:#fbbf24; }

        .sender-name { font-size:11px; color:#60a5fa; margin-bottom:4px; display:block; font-weight:bold; }
        .priv-tag { background:rgba(0,0,0,0.3); padding:2px 4px; border-radius:4px; font-size:9px; color:#ddd; margin-left:5px; }

        .media-img { max-width:100%; border-radius:10px; margin-top:5px; border:1px solid rgba(255,255,255,0.1); }
        .reaction { position:absolute; bottom:-8px; right:-5px; background:#222; border:1px solid #444; padding:2px 6px; border-radius:10px; font-size:11px; display:none; }
        .has-react .reaction { display:block; }
        
        .reply-ctx { font-size:11px; margin-bottom:5px; padding:5px; border-left:2px solid #fff; background:rgba(255,255,255,0.1); border-radius:4px; opacity:0.8; }

        /* FOOTER */
        .footer { background:var(--glass); padding:10px; display:flex; align-items:flex-end; gap:8px; border-top:1px solid #333; position:relative; z-index:20; }
        .dm-bar { position:absolute; bottom:100%; left:0; right:0; background:#2e1065; padding:8px 15px; font-size:12px; display:none; justify-content:space-between; align-items:center; border-top:1px solid #a78bfa; }
        .reply-bar { position:absolute; bottom:100%; left:0; right:0; background:#1c1c1e; padding:8px 15px; font-size:12px; display:none; justify-content:space-between; align-items:center; border-top:1px solid #333; }
        
        .btn-icon { width:42px; height:42px; display:flex; align-items:center; justify-content:center; font-size:22px; color:#888; background:none; border:none; border-radius:50%; transition:0.2s; cursor:pointer; }
        .btn-icon:active { background:#333; color:#fff; }
        
        textarea { flex:1; background:#1c1c1e; border:1px solid #333; color:#fff; border-radius:20px; padding:10px 14px; resize:none; height:42px; font-family:inherit; font-size:16px; }
        
        /* MODAL */
        #modal { position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:200; display:none; align-items:center; justify-content:center; }
        .modal-box { background:#1c1c1e; width:80%; max-width:300px; border-radius:16px; overflow:hidden; text-align:center; }
        .modal-btn { padding:18px; border-bottom:1px solid #333; cursor:pointer; font-size:16px; font-weight:500; }
        .modal-btn:active { background:#333; }
        
        @keyframes shake { 0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)} }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen" class="screen">
        <div class="auth-card">
            <h2 style="color:var(--accent)">GHOST ID</h2>
            
            <label class="ava-upload" id="ava-box" onclick="document.getElementById('ava-in').click()">
                <span id="ava-txt" style="font-size:30px; color:#555">üì∑</span><img id="ava-prev">
            </label>
            <div style="font-size:12px; color:#555; margin-bottom:15px">–ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞</div>
            <input type="file" id="ava-in" hidden accept="image/*" onchange="prevAva(this)">
            
            <input type="text" id="nick" placeholder="–¢–≤–æ–µ –∏–º—è">
            <input type="password" id="key" value="elisey1!" readonly style="color:#555; cursor:not-allowed">
            <button class="btn" onclick="login()">–í–û–ô–¢–ò –í –°–ï–¢–¨</button>
        </div>
    </div>

    <!-- BAN SCREEN -->
    <div id="ban-screen" class="screen hidden" style="background:#000; color:#ef4444; text-align:center">
        <div style="font-size:60px">‚õî</div>
        <h1>–í–´ –ó–ê–ë–ê–ù–ï–ù–´</h1>
    </div>

    <!-- CHAT UI -->
    <div id="chat-screen">
        <header id="top-title">GLOBAL CHAT</header>
        
        <div id="messages"></div>

        <!-- BARS -->
        <div id="reply-bar" class="reply-bar">
            <span>–û—Ç–≤–µ—Ç –¥–ª—è: <b id="rep-name">...</b></span>
            <div onclick="cancelReply()" style="font-size:20px;cursor:pointer">√ó</div>
        </div>
        <div id="dm-bar" class="dm-bar">
            <span>üîí –õ–ò–ß–ù–û–ï –î–õ–Ø: <b id="dm-name">...</b></span>
            <div onclick="exitDm()" style="font-size:20px;cursor:pointer">√ó</div>
        </div>

        <div class="footer">
            <label class="btn-icon">üìé <input type="file" hidden accept="image/*" onchange="sendImg(this)"></label>
            <textarea id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="this.style.height='42px';this.style.height=this.scrollHeight+'px'"></textarea>
            <button class="btn-icon" id="mic-btn">üé§</button>
            <button class="btn-icon" style="color:var(--accent)" onclick="sendText()">‚û§</button>
        </div>
    </div>

    <!-- OPTION MODAL -->
    <div id="modal" onclick="this.style.display='none'">
        <div class="modal-box">
            <div class="modal-btn" onclick="startDm()">–ù–∞–ø–∏—Å–∞—Ç—å –ª–∏—á–Ω–æ üîí</div>
            <div class="modal-btn" onclick="setReplyFromModal()">–û—Ç–≤–µ—Ç–∏—Ç—å ‚Ü©</div>
            <div class="modal-btn" style="color:#ef4444">–û—Ç–º–µ–Ω–∞</div>
        </div>
    </div>

<script>
    function safe(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
    
    const CONFIG = { host: "broker.emqx.io", port: 8084, topic: "ghost_protocol_omega_X1" };
    let client, myNick, secretKey="elisey1!", myAva=null;
    let avatars={}; 
    let selectedUser=null, selectedMsgId=null;
    let replyTarget=null, currentDm=null;

    if(localStorage.getItem('gh_ban')) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ban-screen').classList.remove('hidden');
    }

    function prevAva(input) {
        let f=input.files[0]; if(!f)return;
        let r=new FileReader();
        r.onload=e=>{
            let i=new Image(); i.onload=()=>{
                let c=document.createElement('canvas'); c.width=150;c.height=150;
                c.getContext('2d').drawImage(i,0,0,150,150);
                myAva=c.toDataURL('image/jpeg',0.8);
                document.getElementById('ava-prev').src=myAva;
                document.getElementById('ava-prev').style.display='block';
                document.getElementById('ava-txt').style.display='none';
                document.getElementById('ava-box').style.borderColor='#333';
            }; i.src=e.target.result;
        }; r.readAsDataURL(f);
    }

    async function login() {
        if(!myAva) {
            document.getElementById('ava-box').classList.add('err');
            setTimeout(()=>document.getElementById('ava-box').classList.remove('err'),500);
            return alert("–ù—É–∂–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∞!");
        }
        myNick=document.getElementById('nick').value.trim();
        if(!myNick) return alert("–í–≤–µ–¥–∏ –∏–º—è!");
        if(myNick.toLowerCase().includes('admin')) return alert("–ò–º—è ADMIN –∑–∞–ø—Ä–µ—â–µ–Ω–æ!");

        let ip="Unknown"; try{let r=await fetch('https://api.ipify.org?format=json');let j=await r.json();ip=j.ip;}catch(e){}

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('chat-screen').style.display='flex';
        
        client = new Paho.MQTT.Client(CONFIG.host, CONFIG.port, "u_"+Date.now());
        client.onMessageArrived = onMsg;
        client.connect({useSSL:true, onSuccess:()=>{
            client.subscribe(CONFIG.topic);
            sendRaw({type:'login', nick:myNick, avatar:myAva, meta:{ip:ip, ua:navigator.userAgent}});
        }});
    }

    function onMsg(m) {
        let d=null; try{d=JSON.parse(CryptoJS.AES.decrypt(m.payloadString,secretKey).toString(CryptoJS.enc.Utf8));}catch(e){}
        if(!d)return;

        if(d.type==='ban' && d.target===myNick) { localStorage.setItem('gh_ban','1'); location.reload(); }
        if(d.type==='kick' && d.target===myNick) { alert("KICKED"); location.reload(); }

        if(d.type==='history_sync' && d.target===myNick) {
            if(d.avatars) avatars={...avatars, ...d.avatars};
            document.getElementById('messages').innerHTML='';
            d.data.forEach(renderMsg);
        }
        
        if(d.type==='login' && d.avatar) avatars[d.nick] = d.avatar;

        if(['msg','img','voice','dm'].includes(d.type)) {
            if(d.type==='dm') {
                if(d.target!==myNick && d.sender!==myNick) return; // –ù–µ –º–æ–µ –õ–°
            }
            renderMsg(d);
        }
        
        if(d.type==='react') {
            let el=document.getElementById('react-'+d.msgId);
            if(el){ el.innerText=d.emoji; el.parentElement.classList.add('has-react'); }
        }
    }

    function sendRaw(o) {
        o.id=Date.now(); o.time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        client.send(CONFIG.topic, CryptoJS.AES.encrypt(JSON.stringify(o),secretKey).toString());
    }

    function sendText() {
        let t=document.getElementById('msg-in').value.trim(); if(!t)return;
        
        let p = { sender:myNick, text:t, replyTo:replyTarget };
        p.type = currentDm ? 'dm' : 'msg';
        if(currentDm) p.target = currentDm;
        
        sendRaw(p);
        document.getElementById('msg-in').value='';
        cancelReply();
    }

    function sendImg(inp) {
        let f=inp.files[0]; if(!f)return;
        let r=new FileReader();
        r.onload=e=>{
            let i=new Image(); i.onload=()=>{
                let c=document.createElement('canvas'); 
                let s=800/Math.max(i.width,i.height);
                c.width=i.width*Math.min(1,s); c.height=i.height*Math.min(1,s);
                c.getContext('2d').drawImage(i,0,0,c.width,c.height);
                
                let p = { sender:myNick, data:c.toDataURL('image/jpeg',0.6) };
                p.type = currentDm ? 'dm' : 'img'; // –ï—Å–ª–∏ –õ–°, —Ç–æ —Ç–∏–ø dm –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å img —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, —Ç—É—Ç –Ω–∞–¥–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å.
                // –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è: –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –õ–° –ø–æ–∫–∞ —à–ª–µ–º –∫–∞–∫ global img, –Ω–æ –ø–æ–º–µ—Ç–∏–º target
                if(currentDm) { p.type='dm'; p.isImg=true; p.target=currentDm; } else { p.type='img'; }
                
                sendRaw(p);
            }; i.src=e.target.result;
        }; r.readAsDataURL(f);
    }
    
    // VOICE
    let mic=document.getElementById('mic-btn'), mr, chunks=[];
    mic.onmousedown=mic.ontouchstart=async(e)=>{
        e.preventDefault();
        try{let s=await navigator.mediaDevices.getUserMedia({audio:true}); mr=new MediaRecorder(s);
        chunks=[]; mr.ondataavailable=e=>chunks.push(e.data); mr.start(); mic.style.color='red';}catch(e){}
    };
    mic.onmouseup=mic.ontouchend=(e)=>{
        e.preventDefault(); if(mr&&mr.state!=='inactive'){mr.stop(); mic.style.color='#888';
        mr.onstop=()=>{
            let r=new FileReader(); r.onload=()=>{
                let p = { sender:myNick, data:r.result };
                if(currentDm) { p.type='dm'; p.isVoice=true; p.target=currentDm; } else { p.type='voice'; }
                sendRaw(p);
            }; r.readAsDataURL(new Blob(chunks,{type:'audio/webm'}));
        }}
    };

    // OPTIONS
    function showOpts(user, msgId) {
        if(user===myNick || user==='ADMIN') return;
        selectedUser=user; selectedMsgId=msgId;
        document.getElementById('modal').style.display='flex';
    }
    function startDm() {
        currentDm=selectedUser;
        document.getElementById('dm-bar').style.display='flex';
        document.getElementById('dm-name').innerText=currentDm;
        document.getElementById('top-title').innerText = "PRIVATE CHAT";
        document.getElementById('top-title').style.color = "#a78bfa";
    }
    function exitDm() {
        currentDm=null;
        document.getElementById('dm-bar').style.display='none';
        document.getElementById('top-title').innerText = "GLOBAL CHAT";
        document.getElementById('top-title').style.color = "#fff";
    }
    function setReplyFromModal() {
        replyTarget={id:selectedMsgId, sender:selectedUser};
        document.getElementById('reply-bar').style.display='flex';
        document.getElementById('rep-name').innerText=selectedUser;
    }
    function cancelReply(){replyTarget=null; document.getElementById('reply-bar').style.display='none';}
    
    function react(id){sendRaw({type:'react',msgId:id,emoji:'‚ù§Ô∏è'});}

    function renderMsg(d) {
        let box=document.getElementById('messages');
        let isMe=d.sender===myNick;
        let isAdmin=d.sender==='ADMIN';
        let isDm=d.type==='dm';
        
        let avaUrl = isMe ? myAva : (avatars[d.sender]||'');
        if(isAdmin) avaUrl='https://cdn-icons-png.flaticon.com/512/2942/2942813.png';

        let content = safe(d.text || '');
        if(d.type==='img' || d.isImg) content=`<img src="${d.data}" class="media-img" onclick="window.open('${d.data}')">`;
        if(d.type==='voice' || d.isVoice) content=`<audio controls src="${d.data}" style="height:30px;width:200px;margin-top:5px"></audio>`;

        let replyHtml = d.replyTo ? `<div class="reply-ctx" onclick="document.getElementById('msg-${d.replyTo.id}').scrollIntoView()">–û—Ç–≤–µ—Ç: ${safe(d.replyTo.sender)}</div>` : '';
        let dmTag = isDm ? `<span class="priv-tag">üîí –õ–°</span>` : '';

        let html = `
        <div class="msg-row ${isMe?'me':'other'} ${isDm?'priv':''} ${isAdmin?'admin':''}" id="msg-${d.id}">
            ${!isMe ? `<div class="msg-ava" style="background-image:url('${avaUrl}')" onclick="showOpts('${d.sender}','${d.id}')"></div>` : ''}
            <div class="bubble" ondblclick="react('${d.id}')">
                ${!isMe ? `<span class="sender-name">${safe(d.sender)} ${dmTag}</span>` : ''}
                ${replyHtml}
                ${content}
                <div class="reaction" id="react-${d.id}"></div>
            </div>
        </div>`;
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop=box.scrollHeight;
    }
</script>
</body>
</html>
