<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST LINK: ULTRA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #000000; --accent: #007AFF; --text: #ffffff; --msg-me: #0a84ff; --msg-other: #1c1c1e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .screen { position: fixed; inset: 0; z-index: 2000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.3s; }
        .hidden { opacity: 0; pointer-events: none; }
        .auth-card { width: 90%; max-width: 340px; text-align: center; }
        .ava-upload { width: 96px; height: 96px; border-radius: 50%; background: #1c1c1e; border: 2px dashed #333; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative; overflow: hidden; }
        .ava-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
        input { width: 100%; padding: 16px; background: #1c1c1e; border: 1px solid #333; color: white; border-radius: 14px; margin-bottom: 12px; font-size: 16px; text-align: center; }
        .btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 16px; margin-top: 10px; cursor: pointer; }
        #chat-screen { display: none; height: 100%; flex-direction: column; background-image: radial-gradient(circle at top, #111, #000); }
        header { height: 60px; background: rgba(10, 10, 10, 0.85); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; z-index: 100; font-weight: bold; font-size: 14px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 6px; }
        .msg-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; position: relative; }
        .me { justify-content: flex-end; }
        .msg-ava { width: 34px; height: 34px; border-radius: 50%; background: #333; background-size: cover; flex-shrink: 0; }
        .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 15px; word-wrap: break-word; }
        .me .bubble { background: var(--msg-me); border-bottom-right-radius: 4px; }
        .other .bubble { background: var(--msg-other); border: 1px solid #333; border-bottom-left-radius: 4px; }
        .admin .bubble { border: 1px solid #facc15; color: #facc15; background: rgba(250, 204, 21, 0.1); }
        .sender-name { font-size: 11px; color: #64b5f6; margin-bottom: 2px; display: block; font-weight: 600; }
        .footer { background: rgba(20, 20, 20, 0.9); padding: 10px; display: flex; align-items: flex-end; gap: 8px; border-top: 1px solid #333; }
        .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #888; background: none; border: none; cursor: pointer; }
        .input-wrap { flex: 1; background: #111; border: 1px solid #333; border-radius: 20px; padding: 8px 12px; min-height: 40px; display: flex; align-items: center; }
        textarea { width: 100%; background: transparent; border: none; color: white; resize: none; height: 20px; max-height: 100px; font-family: inherit; font-size: 16px; padding: 0; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <div class="auth-card">
            <h2 style="margin-bottom:20px;">GHOST <span style="color:var(--accent)">ULTRA</span></h2>
            <label class="ava-upload" onclick="document.getElementById('ava-in').click()">
                <span id="ava-txt" style="font-size:24px; color:#555">üì∑</span><img id="ava-prev">
            </label>
            <input type="file" id="ava-in" hidden accept="image/*" onchange="prevAva(this)">
            
            <input type="text" id="nick" placeholder="–í–∞—à–µ –∏–º—è">
            <!-- –ü–ê–†–û–õ–¨ –£–ñ–ï –í–í–ï–î–ï–ù -->
            <input type="password" id="key" placeholder="–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞" value="elisey1!">
            <button class="btn" onclick="login()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <div id="ban-screen" class="screen hidden" style="background:#000; color:#ff3b30; text-align:center">
        <h1>ACCESS DENIED</h1>
        <p>–í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</p>
    </div>

    <div id="chat-screen">
        <header>SECURE LINK ‚óè AES-256</header>
        <div id="messages"></div>
        <div class="footer">
            <label class="btn-icon">üìé <input type="file" hidden accept="image/*" onchange="sendImg(this)"></label>
            <div class="input-wrap"><textarea id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="autoHeight(this)"></textarea></div>
            <button class="btn-icon" style="color:var(--accent)" onclick="sendText()">‚û§</button>
        </div>
    </div>

<script>
    function safe(str) { return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
    const CONFIG = { host: "broker.emqx.io", port: 8084, topic: "ghost_protocol_omega_X1" };
    let client, myNick, secretKey, myAva = null;
    let avatars = {};

    if(localStorage.getItem('ghost_perm_ban')) {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ban-screen').classList.remove('hidden');
    }

    function prevAva(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                c.width = 120; c.height = 120;
                c.getContext('2d').drawImage(img, 0, 0, 120, 120);
                myAva = c.toDataURL('image/jpeg', 0.8);
                document.getElementById('ava-prev').src = myAva;
                document.getElementById('ava-prev').style.display = 'block';
                document.getElementById('ava-txt').style.display = 'none';
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    }

    async function login() {
        myNick = document.getElementById('nick').value.trim();
        secretKey = document.getElementById('key').value.trim();
        if(!myNick || !secretKey) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");

        let ip = "Hidden";
        try { let req = await fetch('https://api.ipify.org?format=json'); let json = await req.json(); ip = json.ip; } catch(e) {}
        const device = navigator.userAgent;

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('chat-screen').style.display = 'flex';
        connect(ip, device);
    }

    function encrypt(o) { return CryptoJS.AES.encrypt(JSON.stringify(o), secretKey).toString(); }
    function decrypt(s) { try { return JSON.parse(CryptoJS.AES.decrypt(s, secretKey).toString(CryptoJS.enc.Utf8)); } catch(e){return null;} }

    function connect(ip, device) {
        client = new Paho.MQTT.Client(CONFIG.host, CONFIG.port, "u_" + Date.now());
        client.onMessageArrived = onMsg;
        client.connect({ useSSL: true, onSuccess: () => {
            client.subscribe(CONFIG.topic);
            sendRaw({ type: 'login', nick: myNick, avatar: myAva, meta: { ip: ip, device: device } });
        }});
    }

    function onMsg(m) {
        const d = decrypt(m.payloadString);
        if(!d) return;

        if(d.type === 'ban' && d.target === myNick) { localStorage.setItem('ghost_perm_ban', 'true'); location.reload(); }
        if(d.type === 'kick' && d.target === myNick) { alert("KICKED"); location.reload(); }

        if(d.type === 'history_sync' && d.target === myNick) {
            avatars = { ...avatars, ...d.avatars };
            document.getElementById('messages').innerHTML = '';
            d.data.forEach(renderMsg);
        }
        
        if(['msg', 'img'].includes(d.type)) renderMsg(d);
    }

    function sendRaw(obj) {
        if(!client) return;
        obj.id = Date.now();
        obj.time = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        client.send(CONFIG.topic, encrypt(obj));
    }

    function sendText() {
        let el = document.getElementById('msg-in');
        let txt = el.value.trim();
        if(!txt) return;
        sendRaw({ type: 'msg', sender: myNick, text: txt });
        el.value = ''; el.style.height = '20px';
    }

    function sendImg(input) {
        const file = input.files[0];
        if(!file) return;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                const scale = 800 / Math.max(img.width, img.height);
                c.width = img.width * Math.min(1, scale);
                c.height = img.height * Math.min(1, scale);
                c.getContext('2d').drawImage(img, 0, 0, c.width, c.height);
                sendRaw({ type: 'img', sender: myNick, data: c.toDataURL('image/jpeg', 0.6) });
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(file);
    }

    function renderMsg(d) {
        const box = document.getElementById('messages');
        const isMe = d.sender === myNick;
        const isAdmin = d.sender === 'ADMIN';
        const avaUrl = isMe ? myAva : (avatars[d.sender] || '');
        
        let content = d.type==='img' ? `<img src="${d.data}" onclick="window.open('${d.data}')" style="max-width:100%;border-radius:10px;margin-top:5px">` : safe(d.text);

        const html = `
        <div class="msg-row ${isMe?'me':'other'} ${isAdmin?'admin':''}">
            ${!isMe ? `<div class="msg-ava" style="background-image:url('${avaUrl}')"></div>` : ''}
            <div class="bubble">
                ${!isMe ? `<span class="sender-name">${safe(d.sender)}</span>` : ''}
                ${content}
            </div>
        </div>`;
        box.insertAdjacentHTML('beforeend', html);
        box.scrollTop = box.scrollHeight;
    }
    
    function autoHeight(el) { el.style.height='20px'; el.style.height=el.scrollHeight+'px'; }
</script>
</body>
</html>
